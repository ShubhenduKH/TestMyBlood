<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Reports - LAB CARE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../../css/style.css" rel="stylesheet">
</head>
<body>
    <div class="dashboard-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h4><i class="bi bi-droplet-fill"></i> LAB<span>CARE</span></h4>
            </div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html"><i class="bi bi-grid-1x2"></i> Dashboard</a></li>
                <li><a href="book-test.html"><i class="bi bi-plus-circle"></i> Book Test</a></li>
                <li><a href="reports.html" class="active"><i class="bi bi-file-earmark-medical"></i> My Reports</a></li>
                <li><a href="profile.html"><i class="bi bi-person"></i> Profile</a></li>
                <li><a href="../public/tests.html"><i class="bi bi-list-ul"></i> Browse Tests</a></li>
                <li><a href="../public/doctors.html"><i class="bi bi-person-badge"></i> Consult Doctor</a></li>
                <li><a href="#" onclick="API.Auth.logout()"><i class="bi bi-box-arrow-left"></i> Logout</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navbar -->
            <div class="top-navbar">
                <button class="btn btn-link d-lg-none" onclick="toggleSidebar()">
                    <i class="bi bi-list fs-4"></i>
                </button>
                <h5 class="mb-0">My Reports</h5>
                <div class="user-menu">
                    <div class="user-info">
                        <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="User">
                        <span id="userName">User</span>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Filter Section -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3 align-items-center">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="searchReports" placeholder="Search by booking ID or test name...">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="statusFilter">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending Payment</option>
                                    <option value="confirmed">Confirmed</option>
                                    <option value="collected">Sample Collected</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="dateFilter">
                                    <option value="">All Time</option>
                                    <option value="7">Last 7 Days</option>
                                    <option value="30">Last 30 Days</option>
                                    <option value="90">Last 3 Months</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-primary w-100" onclick="loadReports()">
                                    <i class="bi bi-funnel me-1"></i>Filter
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading your bookings...</p>
                </div>

                <!-- Reports List -->
                <div class="data-table" id="reportsTable">
                    <div class="table-header">
                        <h5>Booking History & Reports</h5>
                    </div>
                    <div class="table-responsive">
                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th>Booking ID</th>
                                    <th>Tests</th>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Payment</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="reportsList">
                                <tr>
                                    <td colspan="7" class="text-center py-5 text-muted">
                                        <i class="bi bi-file-earmark-x display-4 mb-3 d-block"></i>
                                        No bookings found. <a href="book-test.html">Book a test</a> to get started.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Report Details Modal -->
                <div class="modal fade" id="reportModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Booking Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body" id="reportDetails">
                                <!-- Details will be loaded here -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-danger" id="cancelBookingBtn" style="display: none;">
                                    <i class="bi bi-x-circle me-2"></i>Cancel Booking
                                </button>
                                <button type="button" class="btn btn-primary" id="downloadReportBtn" style="display: none;">
                                    <i class="bi bi-download me-2"></i>Download Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/api.js"></script>
    <script>
        // Check authentication
        if (!API.Auth.isLoggedIn()) {
            window.location.href = 'login.html';
        }

        const user = API.Auth.getCurrentUser();
        let allBookings = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (user) {
                document.getElementById('userName').textContent = user.name;
            }
            loadReports();

            // Add event listeners for filters
            document.getElementById('searchReports').addEventListener('input', filterAndRender);
            document.getElementById('statusFilter').addEventListener('change', filterAndRender);
            document.getElementById('dateFilter').addEventListener('change', filterAndRender);
        });

        // Load reports from API
        async function loadReports() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('reportsTable').style.display = 'none';

            try {
                const response = await API.Bookings.getMyBookings();
                if (response.success) {
                    allBookings = response.data;
                    filterAndRender();
                } else {
                    Utils.showToast('Failed to load bookings', 'danger');
                }
            } catch (error) {
                console.error('Load reports error:', error);
                Utils.showToast('Failed to load bookings. Please try again.', 'danger');
            } finally {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('reportsTable').style.display = 'block';
            }
        }

        // Filter and render bookings
        function filterAndRender() {
            const searchTerm = document.getElementById('searchReports').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = parseInt(document.getElementById('dateFilter').value) || 0;

            let filteredBookings = allBookings.filter(booking => {
                const matchesSearch = booking.booking_id.toLowerCase().includes(searchTerm) ||
                    booking.tests?.some(t => t.test_name.toLowerCase().includes(searchTerm));

                const matchesStatus = !statusFilter || booking.status === statusFilter;

                let matchesDate = true;
                if (dateFilter > 0) {
                    const bookingDate = new Date(booking.created_at);
                    const daysAgo = new Date();
                    daysAgo.setDate(daysAgo.getDate() - dateFilter);
                    matchesDate = bookingDate >= daysAgo;
                }

                return matchesSearch && matchesStatus && matchesDate;
            });

            // Sort by date (newest first)
            filteredBookings.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            renderBookings(filteredBookings);
        }

        // Render bookings table
        function renderBookings(bookings) {
            const tbody = document.getElementById('reportsList');

            if (bookings.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-5 text-muted">
                            <i class="bi bi-file-earmark-x display-4 mb-3 d-block"></i>
                            No bookings found. <a href="book-test.html">Book a test</a> to get started.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = bookings.map(booking => `
                <tr>
                    <td><strong>${booking.booking_id}</strong></td>
                    <td>
                        <span data-bs-toggle="tooltip" title="${booking.tests?.map(t => t.test_name).join(', ') || 'N/A'}">
                            ${booking.tests?.slice(0, 2).map(t => t.test_name).join(', ') || 'N/A'}
                            ${booking.tests?.length > 2 ? `<span class="text-muted">+${booking.tests.length - 2} more</span>` : ''}
                        </span>
                    </td>
                    <td>${new Date(booking.booking_date).toLocaleDateString('en-IN')}</td>
                    <td>₹${parseFloat(booking.total_amount).toFixed(2)}</td>
                    <td>
                        <span class="badge ${getPaymentBadgeClass(booking.payment_status)}">
                            ${booking.payment_status || 'pending'}
                        </span>
                    </td>
                    <td><span class="status-badge ${booking.status}">${formatStatus(booking.status)}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewDetails('${booking.booking_id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                        ${booking.status === 'completed' && (booking.report_file || booking.report_url) ?
                            `<button class="btn btn-sm btn-primary" onclick="downloadReport('${booking.booking_id}')">
                                <i class="bi bi-download"></i>
                            </button>` :
                            ''
                        }
                    </td>
                </tr>
            `).join('');

            // Initialize tooltips
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
        }

        // Get payment badge class
        function getPaymentBadgeClass(status) {
            switch(status) {
                case 'paid': return 'bg-success';
                case 'failed': return 'bg-danger';
                case 'refunded': return 'bg-secondary';
                default: return 'bg-warning text-dark';
            }
        }

        // Format status for display
        function formatStatus(status) {
            const statusMap = {
                'pending': 'Pending',
                'confirmed': 'Confirmed',
                'collected': 'Sample Collected',
                'completed': 'Completed',
                'cancelled': 'Cancelled'
            };
            return statusMap[status] || status;
        }

        // View booking details
        async function viewDetails(bookingId) {
            const booking = allBookings.find(b => b.booking_id === bookingId);
            if (!booking) return;

            const details = document.getElementById('reportDetails');
            details.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">Booking Information</h6>
                        <p><strong>Booking ID:</strong> ${booking.booking_id}</p>
                        <p><strong>Date:</strong> ${new Date(booking.booking_date).toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        <p><strong>Time:</strong> ${booking.time_slot}</p>
                        <p><strong>Status:</strong> <span class="status-badge ${booking.status}">${formatStatus(booking.status)}</span></p>
                        <p><strong>Payment:</strong> <span class="badge ${getPaymentBadgeClass(booking.payment_status)}">${booking.payment_status || 'pending'}</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">Collection Address</h6>
                        <p>${booking.patient_name}</p>
                        <p>${booking.address_line1}</p>
                        ${booking.address_line2 ? `<p>${booking.address_line2}</p>` : ''}
                        <p>${booking.city} - ${booking.pincode}</p>
                        <p>Phone: ${booking.phone}</p>
                    </div>
                </div>
                <hr>
                <h6 class="text-muted mb-3">Tests</h6>
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Test Name</th>
                            <th>Lab</th>
                            <th class="text-end">Price</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${booking.tests?.map(test => `
                            <tr>
                                <td>${test.test_name}</td>
                                <td>${test.lab_name || 'N/A'}</td>
                                <td class="text-end">₹${parseFloat(test.test_price).toFixed(2)}</td>
                            </tr>
                        `).join('') || '<tr><td colspan="3">No tests found</td></tr>'}
                        <tr class="table-light">
                            <td colspan="2"><strong>Total</strong></td>
                            <td class="text-end"><strong>₹${parseFloat(booking.total_amount).toFixed(2)}</strong></td>
                        </tr>
                    </tbody>
                </table>
                ${getStatusMessage(booking)}
                ${booking.collector ? `
                    <div class="alert alert-info mt-3">
                        <strong><i class="bi bi-person me-2"></i>Assigned Phlebotomist:</strong>
                        <p class="mb-0">${booking.collector.name} - ${booking.collector.phone}</p>
                    </div>
                ` : ''}
                ${booking.report_notes ? `
                    <div class="alert alert-secondary mt-3">
                        <strong><i class="bi bi-file-text me-2"></i>Report Notes:</strong>
                        <p class="mb-0">${booking.report_notes}</p>
                    </div>
                ` : ''}
            `;

            // Setup buttons
            const downloadBtn = document.getElementById('downloadReportBtn');
            const cancelBtn = document.getElementById('cancelBookingBtn');

            downloadBtn.style.display = booking.status === 'completed' && (booking.report_file || booking.report_url) ? 'block' : 'none';
            downloadBtn.onclick = () => downloadReport(bookingId);

            cancelBtn.style.display = (booking.status === 'pending' || booking.status === 'confirmed') && booking.payment_status !== 'paid' ? 'block' : 'none';
            cancelBtn.onclick = () => cancelBooking(bookingId);

            const modal = new bootstrap.Modal(document.getElementById('reportModal'));
            modal.show();
        }

        // Get status message
        function getStatusMessage(booking) {
            if (booking.status === 'completed') {
                return `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        Your report is ready! Click the download button below.
                    </div>
                `;
            } else if (booking.status === 'collected') {
                return `
                    <div class="alert alert-info">
                        <i class="bi bi-hourglass-split me-2"></i>
                        Sample collected. Report will be ready within 24-48 hours.
                    </div>
                `;
            } else if (booking.status === 'confirmed') {
                return `
                    <div class="alert alert-warning">
                        <i class="bi bi-clock me-2"></i>
                        Our phlebotomist will arrive at your location on the scheduled date and time.
                    </div>
                `;
            } else if (booking.status === 'cancelled') {
                return `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle me-2"></i>
                        This booking has been cancelled.
                    </div>
                `;
            } else if (booking.payment_status !== 'paid') {
                return `
                    <div class="alert alert-warning">
                        <i class="bi bi-credit-card me-2"></i>
                        Payment pending. Please complete the payment to confirm your booking.
                    </div>
                `;
            }
            return `
                <div class="alert alert-secondary">
                    <i class="bi bi-info-circle me-2"></i>
                    Your booking is being processed. You will receive a confirmation soon.
                </div>
            `;
        }

        // Download report
        async function downloadReport(bookingId) {
            try {
                Utils.showToast('Preparing download...', 'info');

                // Open the download URL in a new window/tab
                const downloadUrl = `http://localhost:5001/api/bookings/${bookingId}/download`;

                // Create a temporary link and trigger download
                const token = localStorage.getItem('token');
                const response = await fetch(downloadUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to download report');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report-${bookingId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();

                Utils.showToast('Report downloaded successfully!', 'success');
            } catch (error) {
                console.error('Download error:', error);
                Utils.showToast('Failed to download report. Please try again.', 'danger');
            }
        }

        // Cancel booking
        async function cancelBooking(bookingId) {
            if (!confirm('Are you sure you want to cancel this booking?')) {
                return;
            }

            try {
                const response = await API.Bookings.cancel(bookingId);
                if (response.success) {
                    Utils.showToast('Booking cancelled successfully', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
                    loadReports();
                } else {
                    throw new Error(response.message || 'Failed to cancel booking');
                }
            } catch (error) {
                console.error('Cancel error:', error);
                Utils.showToast(error.message || 'Failed to cancel booking', 'danger');
            }
        }

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
        }
    </script>
</body>
</html>
