<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - DoorToTest</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../../css/style.css" rel="stylesheet">
</head>
<body>
    <div class="dashboard-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h4><img src="../../images/logo.svg" alt="DoorToTest" width="28" height="28"> Door<span>ToTest</span></h4>
            </div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html"><i class="bi bi-grid-1x2"></i> Dashboard</a></li>
                <li><a href="book-test.html"><i class="bi bi-plus-circle"></i> Book Test</a></li>
                <li><a href="reports.html"><i class="bi bi-file-earmark-medical"></i> My Reports</a></li>
                <li><a href="profile.html" class="active"><i class="bi bi-person"></i> Profile</a></li>
                <li><a href="../public/tests.html"><i class="bi bi-list-ul"></i> Browse Tests</a></li>
                <li><a href="../public/doctors.html"><i class="bi bi-person-badge"></i> Consult Doctor</a></li>
                <li><a href="#" onclick="logout()"><i class="bi bi-box-arrow-left"></i> Logout</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navbar -->
            <div class="top-navbar">
                <button class="btn btn-link d-lg-none" onclick="toggleSidebar()">
                    <i class="bi bi-list fs-4"></i>
                </button>
                <h5 class="mb-0">My Profile</h5>
                <div class="user-menu">
                    <div class="user-info">
                        <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="User">
                        <span id="userName">User</span>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <div class="row">
                    <!-- Profile Card -->
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="Profile" class="rounded-circle mb-3" style="width: 120px; height: 120px; object-fit: cover; border: 4px solid var(--light-color);">
                                <h5 id="profileName">User Name</h5>
                                <p class="text-muted" id="profileEmail">user@email.com</p>
                                <span class="badge bg-success">Verified</span>
                                <hr>
                                <div class="row text-center">
                                    <div class="col-4">
                                        <h5 id="totalBookingsCount">0</h5>
                                        <small class="text-muted">Bookings</small>
                                    </div>
                                    <div class="col-4">
                                        <h5 id="completedCount">0</h5>
                                        <small class="text-muted">Completed</small>
                                    </div>
                                    <div class="col-4">
                                        <h5 id="reportsCount">0</h5>
                                        <small class="text-muted">Reports</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Stats -->
                        <div class="card mt-4">
                            <div class="card-body">
                                <h6 class="card-title mb-3">Account Information</h6>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Member Since</span>
                                    <span id="memberSince">-</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Account Type</span>
                                    <span class="badge bg-primary">Patient</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">Email Status</span>
                                    <span class="text-success"><i class="bi bi-check-circle me-1"></i>Verified</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Details -->
                    <div class="col-lg-8">
                        <!-- Personal Information -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h5 class="card-title mb-0">Personal Information</h5>
                                    <button class="btn btn-outline-primary btn-sm" onclick="toggleEdit('personal')">
                                        <i class="bi bi-pencil me-1"></i>Edit
                                    </button>
                                </div>
                                <form id="personalForm">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Full Name</label>
                                            <input type="text" class="form-control" id="fullName" disabled>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Email Address</label>
                                            <input type="email" class="form-control" id="email" disabled>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Phone Number</label>
                                            <input type="tel" class="form-control" id="phone" disabled>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Date of Birth</label>
                                            <input type="date" class="form-control" id="dob" disabled>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Gender</label>
                                            <select class="form-select" id="gender" disabled>
                                                <option value="">Select Gender</option>
                                                <option value="male">Male</option>
                                                <option value="female">Female</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Blood Group</label>
                                            <select class="form-select" id="bloodGroup" disabled>
                                                <option value="">Select Blood Group</option>
                                                <option value="A+">A+</option>
                                                <option value="A-">A-</option>
                                                <option value="B+">B+</option>
                                                <option value="B-">B-</option>
                                                <option value="AB+">AB+</option>
                                                <option value="AB-">AB-</option>
                                                <option value="O+">O+</option>
                                                <option value="O-">O-</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="personalButtons" class="mt-3" style="display: none;">
                                        <button type="submit" class="btn btn-primary">Save Changes</button>
                                        <button type="button" class="btn btn-outline-secondary ms-2" onclick="cancelEdit('personal')">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Address Information -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h5 class="card-title mb-0">Address</h5>
                                    <button class="btn btn-outline-primary btn-sm" onclick="toggleEdit('address')">
                                        <i class="bi bi-pencil me-1"></i>Edit
                                    </button>
                                </div>
                                <form id="addressForm">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label class="form-label">Address Line 1</label>
                                            <input type="text" class="form-control" id="addressLine1" placeholder="House/Flat No., Building Name" disabled>
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label">Address Line 2</label>
                                            <input type="text" class="form-control" id="addressLine2" placeholder="Street, Area" disabled>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">City</label>
                                            <input type="text" class="form-control" id="city" disabled>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">State</label>
                                            <input type="text" class="form-control" id="state" disabled>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">PIN Code</label>
                                            <input type="text" class="form-control" id="pincode" disabled>
                                        </div>
                                    </div>
                                    <div id="addressButtons" class="mt-3" style="display: none;">
                                        <button type="submit" class="btn btn-primary">Save Changes</button>
                                        <button type="button" class="btn btn-outline-secondary ms-2" onclick="cancelEdit('address')">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Change Password -->
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title mb-4">Change Password</h5>
                                <form id="passwordForm">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Current Password</label>
                                            <input type="password" class="form-control" id="currentPassword" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">New Password</label>
                                            <input type="password" class="form-control" id="newPassword" required minlength="6">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Confirm New Password</label>
                                            <input type="password" class="form-control" id="confirmPassword" required>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary mt-3">Update Password</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/api.js"></script>
    <script>
        let user = null;

        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication
            if (!API.Auth.isLoggedIn()) {
                window.location.href = 'login.html';
                return;
            }

            user = API.Auth.getCurrentUser();
            if (!user || user.user_type !== 'patient') {
                window.location.href = 'login.html';
                return;
            }

            // Load fresh profile data from backend
            await loadProfile();

            // Setup form handlers
            setupFormHandlers();
        });

        // Load profile data
        async function loadProfile() {
            try {
                const result = await API.Auth.getProfile();
                if (result.success) {
                    user = result.data;
                    // Update localStorage
                    localStorage.setItem('currentUser', JSON.stringify(user));
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }

            if (!user) return;

            // Header
            document.getElementById('userName').textContent = user.name;

            // Profile card
            document.getElementById('profileName').textContent = user.name;
            document.getElementById('profileEmail').textContent = user.email;

            // Personal info
            document.getElementById('fullName').value = user.name || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('dob').value = user.dob ? user.dob.split('T')[0] : '';
            document.getElementById('gender').value = user.gender || '';
            document.getElementById('bloodGroup').value = user.blood_group || '';

            // Address
            document.getElementById('addressLine1').value = user.address_line1 || '';
            document.getElementById('addressLine2').value = user.address_line2 || '';
            document.getElementById('city').value = user.city || '';
            document.getElementById('state').value = user.state || '';
            document.getElementById('pincode').value = user.pincode || '';

            // Stats
            try {
                const bookingsResult = await API.Bookings.getMyBookings();
                const bookings = bookingsResult.success ? bookingsResult.data : [];
                document.getElementById('totalBookingsCount').textContent = bookings.length;
                document.getElementById('completedCount').textContent = bookings.filter(b => b.status === 'completed').length;
                document.getElementById('reportsCount').textContent = bookings.filter(b => b.report_url).length;
            } catch (e) {
                console.error('Error loading bookings:', e);
            }

            // Member since
            if (user.created_at) {
                document.getElementById('memberSince').textContent = new Date(user.created_at).toLocaleDateString('en-IN', {
                    year: 'numeric', month: 'short'
                });
            }
        }

        // Toggle edit mode
        function toggleEdit(section) {
            const form = document.getElementById(section + 'Form');
            const buttons = document.getElementById(section + 'Buttons');
            const inputs = form.querySelectorAll('input, select');

            inputs.forEach(input => {
                if (input.id !== 'email') { // Email shouldn't be editable
                    input.disabled = !input.disabled;
                }
            });

            buttons.style.display = buttons.style.display === 'none' ? 'block' : 'none';
        }

        // Cancel edit
        function cancelEdit(section) {
            toggleEdit(section);
            loadProfile(); // Reset values
        }

        function setupFormHandlers() {
            // Save personal info
            document.getElementById('personalForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const profileData = {
                    name: document.getElementById('fullName').value,
                    phone: document.getElementById('phone').value,
                    dob: document.getElementById('dob').value,
                    gender: document.getElementById('gender').value,
                    blood_group: document.getElementById('bloodGroup').value
                };

                try {
                    const result = await API.Auth.updateProfile(profileData);
                    if (result.success) {
                        Utils.showToast('Profile updated successfully!', 'success');
                        toggleEdit('personal');
                        await loadProfile();
                    } else {
                        Utils.showToast(result.message || 'Failed to update profile', 'danger');
                    }
                } catch (error) {
                    Utils.showToast(error.message || 'Failed to update profile', 'danger');
                }
            });

            // Save address
            document.getElementById('addressForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const addressData = {
                    address_line1: document.getElementById('addressLine1').value,
                    address_line2: document.getElementById('addressLine2').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    pincode: document.getElementById('pincode').value
                };

                try {
                    const result = await API.Auth.updateProfile(addressData);
                    if (result.success) {
                        Utils.showToast('Address updated successfully!', 'success');
                        toggleEdit('address');
                        await loadProfile();
                    } else {
                        Utils.showToast(result.message || 'Failed to update address', 'danger');
                    }
                } catch (error) {
                    Utils.showToast(error.message || 'Failed to update address', 'danger');
                }
            });

            // Change password
            document.getElementById('passwordForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (newPassword !== confirmPassword) {
                    Utils.showToast('New passwords do not match!', 'danger');
                    return;
                }

                try {
                    const result = await API.Auth.changePassword(currentPassword, newPassword);
                    if (result.success) {
                        Utils.showToast('Password changed successfully!', 'success');
                        this.reset();
                    } else {
                        Utils.showToast(result.message || 'Failed to change password', 'danger');
                    }
                } catch (error) {
                    Utils.showToast(error.message || 'Failed to change password', 'danger');
                }
            });
        }

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
        }

        function logout() {
            API.Auth.logout();
        }
    </script>
</body>
</html>
