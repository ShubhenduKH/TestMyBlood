<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Test My Blood</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../../css/style.css" rel="stylesheet">
</head>
<body>
    <div class="dashboard-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h4><i class="bi bi-droplet-fill"></i> Test<span>MyBlood</span></h4>
                <small class="text-white-50">Admin Panel</small>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" onclick="showTab('dashboard')" class="active" id="dashboardLink"><i class="bi bi-grid-1x2"></i> Dashboard</a></li>
                <li><a href="#" onclick="showTab('bookings')" id="bookingsLink"><i class="bi bi-calendar-check"></i> Bookings</a></li>
                <li><a href="#" onclick="showTab('tests')" id="testsLink"><i class="bi bi-clipboard2-pulse"></i> Manage Tests</a></li>
                <li><a href="#" onclick="showTab('labs')" id="labsLink"><i class="bi bi-building"></i> Manage Labs</a></li>
                <li><a href="#" onclick="showTab('doctors')" id="doctorsLink"><i class="bi bi-person-badge"></i> Manage Doctors</a></li>
                <li><a href="#" onclick="showTab('collectors')" id="collectorsLink"><i class="bi bi-people"></i> Collectors</a></li>
                <li><a href="#" onclick="showTab('reports')" id="reportsLink"><i class="bi bi-file-earmark-medical"></i> Upload Reports</a></li>
                <li><a href="#" onclick="showTab('users')" id="usersLink"><i class="bi bi-person-lines-fill"></i> Users</a></li>
                <li><a href="#" onclick="TestMyBlood.logoutUser()"><i class="bi bi-box-arrow-left"></i> Logout</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navbar -->
            <div class="top-navbar">
                <button class="btn btn-link d-lg-none" onclick="toggleSidebar()">
                    <i class="bi bi-list fs-4"></i>
                </button>
                <h5 class="mb-0" id="pageTitle">Dashboard</h5>
                <div class="user-menu">
                    <span class="notification">
                        <i class="bi bi-bell"></i>
                        <span class="badge bg-danger" id="notificationCount">0</span>
                    </span>
                    <div class="user-info">
                        <img src="https://randomuser.me/api/portraits/men/10.jpg" alt="Admin">
                        <span>Admin</span>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard Tab -->
                <div id="dashboardTab">
                    <!-- Stats Cards -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-6 col-lg-3">
                            <div class="stat-card">
                                <div class="stat-icon bg-primary">
                                    <i class="bi bi-calendar-check"></i>
                                </div>
                                <div class="stat-info">
                                    <h3 id="totalBookings">0</h3>
                                    <p>Total Bookings</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="stat-card">
                                <div class="stat-icon bg-warning">
                                    <i class="bi bi-clock"></i>
                                </div>
                                <div class="stat-info">
                                    <h3 id="pendingBookings">0</h3>
                                    <p>Pending</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="stat-card">
                                <div class="stat-icon bg-success">
                                    <i class="bi bi-check-circle"></i>
                                </div>
                                <div class="stat-info">
                                    <h3 id="completedBookings">0</h3>
                                    <p>Completed</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3">
                            <div class="stat-card">
                                <div class="stat-icon bg-info">
                                    <i class="bi bi-people"></i>
                                </div>
                                <div class="stat-info">
                                    <h3 id="totalUsers">0</h3>
                                    <p>Total Users</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Bookings & Quick Actions -->
                    <div class="row g-4">
                        <div class="col-lg-8">
                            <div class="data-table">
                                <div class="table-header">
                                    <h5>Recent Bookings</h5>
                                    <a href="#" onclick="showTab('bookings')" class="btn btn-sm btn-outline-primary">View All</a>
                                </div>
                                <div class="table-responsive">
                                    <table class="table mb-0">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Patient</th>
                                                <th>Date</th>
                                                <th>Status</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recentBookingsTable">
                                            <tr><td colspan="5" class="text-center py-3 text-muted">No bookings</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title mb-4">Quick Actions</h5>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary" onclick="showTab('tests'); openAddModal('test')">
                                            <i class="bi bi-plus-circle me-2"></i>Add New Test
                                        </button>
                                        <button class="btn btn-outline-success" onclick="showTab('labs'); openAddModal('lab')">
                                            <i class="bi bi-building me-2"></i>Add New Lab
                                        </button>
                                        <button class="btn btn-outline-info" onclick="showTab('doctors'); openAddModal('doctor')">
                                            <i class="bi bi-person-plus me-2"></i>Add New Doctor
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="showTab('collectors'); openAddModal('collector')">
                                            <i class="bi bi-person-badge me-2"></i>Add Collector
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bookings Tab -->
                <div id="bookingsTab" style="display: none;">
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row g-3 align-items-center">
                                <div class="col-md-4">
                                    <input type="text" class="form-control" id="searchBooking" placeholder="Search by ID or patient name...">
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select" id="bookingStatusFilter">
                                        <option value="">All Status</option>
                                        <option value="pending">Pending</option>
                                        <option value="confirmed">Confirmed</option>
                                        <option value="collected">Collected</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="date" class="form-control" id="bookingDateFilter">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-primary w-100" onclick="loadBookings()">Filter</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="data-table">
                        <div class="table-header">
                            <h5>All Bookings</h5>
                        </div>
                        <div class="table-responsive">
                            <table class="table mb-0">
                                <thead>
                                    <tr>
                                        <th>Booking ID</th>
                                        <th>Patient</th>
                                        <th>Tests</th>
                                        <th>Date & Time</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Collector</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="bookingsTable">
                                    <tr><td colspan="8" class="text-center py-3 text-muted">No bookings</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Manage Tests Tab -->
                <div id="testsTab" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5>Manage Blood Tests</h5>
                        <button class="btn btn-primary" onclick="openAddModal('test')">
                            <i class="bi bi-plus-circle me-2"></i>Add New Test
                        </button>
                    </div>
                    <div class="data-table">
                        <div class="table-responsive">
                            <table class="table mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Test Name</th>
                                        <th>Category</th>
                                        <th>Lab</th>
                                        <th>Price</th>
                                        <th>Original Price</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="testsTable">
                                    <tr><td colspan="7" class="text-center py-3 text-muted">No tests</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Manage Labs Tab -->
                <div id="labsTab" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5>Manage Labs</h5>
                        <button class="btn btn-primary" onclick="openAddModal('lab')">
                            <i class="bi bi-plus-circle me-2"></i>Add New Lab
                        </button>
                    </div>
                    <div class="data-table">
                        <div class="table-responsive">
                            <table class="table mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Lab Name</th>
                                        <th>Accreditation</th>
                                        <th>Rating</th>
                                        <th>Tests</th>
                                        <th>Address</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="labsTable">
                                    <tr><td colspan="7" class="text-center py-3 text-muted">No labs</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Manage Doctors Tab -->
                <div id="doctorsTab" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5>Manage Doctors</h5>
                        <button class="btn btn-primary" onclick="openAddModal('doctor')">
                            <i class="bi bi-plus-circle me-2"></i>Add New Doctor
                        </button>
                    </div>
                    <div class="data-table">
                        <div class="table-responsive">
                            <table class="table mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Doctor Name</th>
                                        <th>Specialty</th>
                                        <th>Qualification</th>
                                        <th>Experience</th>
                                        <th>Fee</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="doctorsTable">
                                    <tr><td colspan="7" class="text-center py-3 text-muted">No doctors</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Collectors Tab -->
                <div id="collectorsTab" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5>Manage Collectors</h5>
                        <button class="btn btn-primary" onclick="openAddModal('collector')">
                            <i class="bi bi-plus-circle me-2"></i>Add New Collector
                        </button>
                    </div>
                    <div class="data-table">
                        <div class="table-responsive">
                            <table class="table mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Area</th>
                                        <th>Assigned</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="collectorsTable">
                                    <tr><td colspan="7" class="text-center py-3 text-muted">No collectors</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Upload Reports Tab -->
                <div id="reportsTab" style="display: none;">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="data-table">
                                <div class="table-header">
                                    <h5>Completed Collections (Pending Reports)</h5>
                                </div>
                                <div class="table-responsive">
                                    <table class="table mb-0">
                                        <thead>
                                            <tr>
                                                <th>Booking ID</th>
                                                <th>Patient</th>
                                                <th>Tests</th>
                                                <th>Collected At</th>
                                                <th>Report</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="pendingReportsTable">
                                            <tr><td colspan="6" class="text-center py-3 text-muted">No pending reports</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title mb-4">Upload Report</h5>
                                    <form id="uploadReportForm">
                                        <div class="mb-3">
                                            <label class="form-label">Booking ID</label>
                                            <input type="text" class="form-control" id="reportBookingId" placeholder="Enter booking ID" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Report File</label>
                                            <input type="file" class="form-control" id="reportFile" accept=".pdf,.jpg,.png" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Notes (Optional)</label>
                                            <textarea class="form-control" id="reportNotes" rows="3"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="bi bi-upload me-2"></i>Upload Report
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Tab -->
                <div id="usersTab" style="display: none;">
                    <div class="data-table">
                        <div class="table-header">
                            <h5>Registered Users</h5>
                        </div>
                        <div class="table-responsive">
                            <table class="table mb-0">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Type</th>
                                        <th>Joined</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable">
                                    <tr><td colspan="6" class="text-center py-3 text-muted">No users</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Form will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Collector Modal -->
    <div class="modal fade" id="assignModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Collector</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="assignCollectorForm">
                        <input type="hidden" id="assignBookingId">
                        <div class="mb-3">
                            <label class="form-label">Select Collector</label>
                            <select class="form-select" id="collectorSelect" required>
                                <option value="">Choose collector...</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Assign</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/api.js"></script>
    <script src="../../js/main.js"></script>
    <script>
        // Check authentication
        if (!TestMyBlood.isLoggedIn()) {
            window.location.href = 'login.html';
        }

        const user = TestMyBlood.getCurrentUser();
        if (user && user.userType !== 'admin') {
            window.location.href = 'login.html';
        }

        // Show tab
        function showTab(tab) {
            // Hide all tabs
            const tabs = ['dashboard', 'bookings', 'tests', 'labs', 'doctors', 'collectors', 'reports', 'users'];
            tabs.forEach(t => {
                document.getElementById(t + 'Tab').style.display = 'none';
                document.getElementById(t + 'Link')?.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tab + 'Tab').style.display = 'block';
            document.getElementById(tab + 'Link')?.classList.add('active');

            // Update page title
            const titles = {
                dashboard: 'Dashboard',
                bookings: 'Manage Bookings',
                tests: 'Manage Tests',
                labs: 'Manage Labs',
                doctors: 'Manage Doctors',
                collectors: 'Manage Collectors',
                reports: 'Upload Reports',
                users: 'Manage Users'
            };
            document.getElementById('pageTitle').textContent = titles[tab];

            // Load data
            loadTabData(tab);
        }

        // Load tab data
        function loadTabData(tab) {
            switch(tab) {
                case 'dashboard': loadDashboard(); break;
                case 'bookings': loadBookings(); break;
                case 'tests': loadTests(); break;
                case 'labs': loadLabs(); break;
                case 'doctors': loadDoctors(); break;
                case 'collectors': loadCollectors(); break;
                case 'reports': loadPendingReports(); break;
                case 'users': loadUsers(); break;
            }
        }

        // Load dashboard
        async function loadDashboard() {
            try {
                const response = await API.Admin.getDashboard();
                if (response.success) {
                    const stats = response.data;
                    document.getElementById('totalBookings').textContent = stats.bookings.total;
                    document.getElementById('pendingBookings').textContent = stats.bookings.pending;
                    document.getElementById('completedBookings').textContent = stats.bookings.completed;
                    document.getElementById('totalUsers').textContent = stats.users.patients;
                    document.getElementById('notificationCount').textContent = stats.bookings.pending;

                    // Recent bookings
                    const tbody = document.getElementById('recentBookingsTable');
                    if (stats.recentBookings && stats.recentBookings.length > 0) {
                        tbody.innerHTML = stats.recentBookings.map(b => `
                            <tr>
                                <td>${b.booking_id}</td>
                                <td>${b.patient_name}</td>
                                <td>${new Date(b.booking_date).toLocaleDateString()}</td>
                                <td><span class="status-badge ${b.status}">${b.status}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="showTab('bookings')">View</button>
                                </td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        // Load bookings
        async function loadBookings() {
            try {
                const searchTerm = document.getElementById('searchBooking')?.value || '';
                const statusFilter = document.getElementById('bookingStatusFilter')?.value || '';
                const dateFilter = document.getElementById('bookingDateFilter')?.value || '';

                const params = {};
                if (searchTerm) params.search = searchTerm;
                if (statusFilter) params.status = statusFilter;
                if (dateFilter) params.date = dateFilter;

                const response = await API.Bookings.getAll(params);
                const tbody = document.getElementById('bookingsTable');

                if (!response.success || !response.data || response.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center py-3 text-muted">No bookings found</td></tr>';
                    return;
                }

                const bookings = response.data;

                tbody.innerHTML = bookings.map(b => `
                    <tr>
                        <td><strong>${b.booking_id}</strong></td>
                        <td>${b.patient_name || ''}<br><small class="text-muted">${b.phone || ''}</small></td>
                        <td><small>${b.tests?.map(t => t.test_name).join(', ').substring(0, 30) || 'N/A'}...</small></td>
                        <td>${new Date(b.booking_date).toLocaleDateString()}<br><small>${b.time_slot || ''}</small></td>
                        <td>₹${b.total_amount || 0}</td>
                        <td><span class="status-badge ${b.status}">${b.status}</span></td>
                        <td>${b.collector ? b.collector.name : '<span class="text-muted">Not assigned</span>'}</td>
                        <td>
                            ${b.status === 'pending' ? `
                                <button class="btn btn-sm btn-success me-1" onclick="updateStatus('${b.booking_id}', 'confirmed')">
                                    <i class="bi bi-check"></i>
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="openAssignModal('${b.booking_id}')">
                                    <i class="bi bi-person-plus"></i>
                                </button>
                            ` : b.status === 'confirmed' && !b.collector_id ? `
                                <button class="btn btn-sm btn-primary" onclick="openAssignModal('${b.booking_id}')">
                                    <i class="bi bi-person-plus"></i>
                                </button>
                            ` : b.status === 'collected' ? `
                                <button class="btn btn-sm btn-success" onclick="updateStatus('${b.booking_id}', 'completed')">
                                    Complete
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load bookings:', error);
                const tbody = document.getElementById('bookingsTable');
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-3 text-danger">Failed to load bookings</td></tr>';
            }
        }

        async function updateStatus(bookingId, status) {
            try {
                const response = await API.Bookings.updateStatus(bookingId, status);
                if (response.success) {
                    showToast('Status updated!', 'success');
                    loadBookings();
                    loadDashboard();
                }
            } catch (error) {
                console.error('Failed to update status:', error);
                showToast('Failed to update status', 'danger');
            }
        }

        async function openAssignModal(bookingId) {
            document.getElementById('assignBookingId').value = bookingId;
            try {
                const response = await API.Admin.getCollectors();
                if (response.success) {
                    const collectors = response.data;
                    document.getElementById('collectorSelect').innerHTML = `
                        <option value="">Choose collector...</option>
                        ${collectors.map(c => `<option value="${c.id}">${c.name} - ${c.area || 'No area'}</option>`).join('')}
                    `;
                }
            } catch (error) {
                console.error('Failed to load collectors:', error);
            }
            new bootstrap.Modal(document.getElementById('assignModal')).show();
        }

        document.getElementById('assignCollectorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const bookingId = document.getElementById('assignBookingId').value;
            const collectorId = parseInt(document.getElementById('collectorSelect').value);

            try {
                const response = await API.Bookings.assignCollector(bookingId, collectorId);
                if (response.success) {
                    showToast('Collector assigned!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('assignModal')).hide();
                    loadBookings();
                    loadDashboard();
                }
            } catch (error) {
                console.error('Failed to assign collector:', error);
                showToast('Failed to assign collector', 'danger');
            }
        });

        // Load tests
        async function loadTests() {
            try {
                const response = await API.Tests.getAll();
                const tbody = document.getElementById('testsTable');

                if (!response.success || !response.data || response.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-3 text-muted">No tests found</td></tr>';
                    return;
                }

                tbody.innerHTML = response.data.map(t => `
                    <tr>
                        <td>${t.id}</td>
                        <td>${t.name}</td>
                        <td><span class="badge bg-light text-dark">${t.category}</span></td>
                        <td>${t.lab_name || ''}</td>
                        <td>₹${t.price}</td>
                        <td>₹${t.original_price || t.price}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editTest(${t.id})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTest(${t.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load tests:', error);
            }
        }

        // Load labs
        async function loadLabs() {
            try {
                const response = await API.Labs.getAll();
                const tbody = document.getElementById('labsTable');

                if (!response.success || !response.data || response.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-3 text-muted">No labs found</td></tr>';
                    return;
                }

                tbody.innerHTML = response.data.map(l => `
                    <tr>
                        <td>${l.id}</td>
                        <td>${l.name}</td>
                        <td>${l.accreditation || '-'}</td>
                        <td>${l.rating || '-'}</td>
                        <td>${l.total_tests || 0}</td>
                        <td><small>${l.address || '-'}</small></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editLab(${l.id})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteLab(${l.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load labs:', error);
            }
        }

        // Load doctors
        async function loadDoctors() {
            try {
                const response = await API.Doctors.getAll();
                const tbody = document.getElementById('doctorsTable');

                if (!response.success || !response.data || response.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-3 text-muted">No doctors found</td></tr>';
                    return;
                }

                tbody.innerHTML = response.data.map(d => `
                    <tr>
                        <td>${d.id}</td>
                        <td>${d.name}</td>
                        <td>${d.specialty}</td>
                        <td>${d.qualification || '-'}</td>
                        <td>${d.experience || 0} yrs</td>
                        <td>₹${d.consultation_fee || 0}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editDoctor(${d.id})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDoctor(${d.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load doctors:', error);
            }
        }

        // Load collectors
        async function loadCollectors() {
            try {
                const response = await API.Admin.getCollectors();
                const tbody = document.getElementById('collectorsTable');

                if (!response.success || !response.data || response.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-3 text-muted">No collectors</td></tr>';
                    return;
                }

                const collectors = response.data;

                tbody.innerHTML = collectors.map(c => `
                    <tr>
                        <td>${c.id}</td>
                        <td>${c.name}</td>
                        <td>${c.email}</td>
                        <td>${c.phone || '-'}</td>
                        <td>${c.area || '-'}</td>
                        <td><span class="badge bg-primary">${c.assigned_count || 0}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCollector(${c.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load collectors:', error);
            }
        }

        // Load pending reports
        async function loadPendingReports() {
            try {
                const response = await API.Bookings.getAll({ status: 'collected' });
                const tbody = document.getElementById('pendingReportsTable');

                const pending = response.success ? response.data : [];

                if (pending.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3 text-muted">No pending reports</td></tr>';
                    return;
                }

                tbody.innerHTML = pending.map(b => `
                    <tr>
                        <td>${b.booking_id}</td>
                        <td>${b.patient_name}</td>
                        <td><small>${b.tests?.map(t => t.test_name).join(', ').substring(0, 40) || 'N/A'}...</small></td>
                        <td>${b.collected_at ? new Date(b.collected_at).toLocaleString() : '-'}</td>
                        <td>${b.report_url ? '<span class="text-success">Uploaded</span>' : '<span class="text-warning">Pending</span>'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="document.getElementById('reportBookingId').value='${b.booking_id}'">
                                Upload
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load pending reports:', error);
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await API.Admin.getUsers();
                const tbody = document.getElementById('usersTable');

                if (!response.success || !response.data || response.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-3 text-muted">No users found</td></tr>';
                    return;
                }

                tbody.innerHTML = response.data.map(u => `
                    <tr>
                        <td>${u.id}</td>
                        <td>${u.name}</td>
                        <td>${u.email}</td>
                        <td>${u.phone || '-'}</td>
                        <td><span class="badge bg-${u.user_type === 'admin' ? 'danger' : u.user_type === 'collector' ? 'warning' : 'primary'}">${u.user_type}</span></td>
                        <td>${u.created_at ? new Date(u.created_at).toLocaleDateString() : '-'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }

        // Open add modal
        async function openAddModal(type) {
            const modal = document.getElementById('addModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');

            const forms = {
                test: `
                    <form id="addTestForm">
                        <div class="mb-3">
                            <label class="form-label">Test Name</label>
                            <input type="text" class="form-control" id="testName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="testDescription" rows="2"></textarea>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Price (₹)</label>
                                <input type="number" class="form-control" id="testPrice" required>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Original Price (₹)</label>
                                <input type="number" class="form-control" id="testOriginalPrice" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="testCategory" required>
                                    <option value="Basic">Basic</option>
                                    <option value="Heart">Heart</option>
                                    <option value="Thyroid">Thyroid</option>
                                    <option value="Diabetes">Diabetes</option>
                                    <option value="Liver">Liver</option>
                                    <option value="Kidney">Kidney</option>
                                    <option value="Vitamin">Vitamin</option>
                                    <option value="Package">Package</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Lab</label>
                                <select class="form-select" id="testLab" required>
                                    <option value="">Loading labs...</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Report Time</label>
                                <input type="text" class="form-control" id="testReportTime" placeholder="e.g., 24 hrs">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Fasting Required</label>
                                <select class="form-select" id="testFasting">
                                    <option value="false">No</option>
                                    <option value="true">Yes</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Add Test</button>
                    </form>
                `,
                lab: `
                    <form id="addLabForm">
                        <div class="mb-3">
                            <label class="form-label">Lab Name</label>
                            <input type="text" class="form-control" id="labName" required>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Accreditation</label>
                                <input type="text" class="form-control" id="labAccreditation" placeholder="e.g., NABL Accredited">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Rating</label>
                                <input type="number" class="form-control" id="labRating" min="1" max="5" step="0.1">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Address</label>
                            <input type="text" class="form-control" id="labAddress">
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="labPhone">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Tests Available</label>
                                <input type="number" class="form-control" id="labTests">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Add Lab</button>
                    </form>
                `,
                doctor: `
                    <form id="addDoctorForm">
                        <div class="mb-3">
                            <label class="form-label">Doctor Name</label>
                            <input type="text" class="form-control" id="doctorName" required>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Specialty</label>
                                <select class="form-select" id="doctorSpecialty" required>
                                    <option value="General Physician">General Physician</option>
                                    <option value="Pathologist">Pathologist</option>
                                    <option value="Diabetologist">Diabetologist</option>
                                    <option value="Cardiologist">Cardiologist</option>
                                    <option value="Endocrinologist">Endocrinologist</option>
                                    <option value="Hematologist">Hematologist</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Qualification</label>
                                <input type="text" class="form-control" id="doctorQualification" placeholder="e.g., MBBS, MD">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Experience (Years)</label>
                                <input type="number" class="form-control" id="doctorExperience">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Consultation Fee (₹)</label>
                                <input type="number" class="form-control" id="doctorFee">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Add Doctor</button>
                    </form>
                `,
                collector: `
                    <form id="addCollectorForm">
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="collectorName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="collectorEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="collectorPassword" required>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="collectorPhone">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Area</label>
                                <input type="text" class="form-control" id="collectorArea" placeholder="e.g., Central Zone">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Add Collector</button>
                    </form>
                `
            };

            title.textContent = 'Add ' + type.charAt(0).toUpperCase() + type.slice(1);
            body.innerHTML = forms[type];

            new bootstrap.Modal(modal).show();

            // Add form handlers
            setTimeout(async () => {
                document.getElementById('addTestForm')?.addEventListener('submit', handleAddTest);
                document.getElementById('addLabForm')?.addEventListener('submit', handleAddLab);
                document.getElementById('addDoctorForm')?.addEventListener('submit', handleAddDoctor);
                document.getElementById('addCollectorForm')?.addEventListener('submit', handleAddCollector);

                // Load labs for test form dropdown
                if (type === 'test') {
                    try {
                        const labsResponse = await API.Labs.getAll();
                        if (labsResponse.success && labsResponse.data) {
                            const labSelect = document.getElementById('testLab');
                            if (labSelect) {
                                labSelect.innerHTML = labsResponse.data.map(l => `<option value="${l.name}">${l.name}</option>`).join('');
                            }
                        }
                    } catch (err) {
                        console.error('Failed to load labs for dropdown:', err);
                    }
                }
            }, 100);
        }

        async function handleAddTest(e) {
            e.preventDefault();
            try {
                const test = {
                    name: document.getElementById('testName').value,
                    description: document.getElementById('testDescription').value,
                    price: parseInt(document.getElementById('testPrice').value),
                    original_price: parseInt(document.getElementById('testOriginalPrice').value),
                    category: document.getElementById('testCategory').value,
                    lab_name: document.getElementById('testLab').value,
                    report_time: document.getElementById('testReportTime').value || '24 hrs',
                    fasting_required: document.getElementById('testFasting').value === 'true'
                };
                const response = await API.Tests.create(test);
                if (response.success) {
                    bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
                    showToast('Test added successfully!', 'success');
                    loadTests();
                }
            } catch (error) {
                console.error('Failed to add test:', error);
                showToast('Failed to add test', 'danger');
            }
        }

        async function handleAddLab(e) {
            e.preventDefault();
            try {
                const lab = {
                    name: document.getElementById('labName').value,
                    accreditation: document.getElementById('labAccreditation').value,
                    rating: parseFloat(document.getElementById('labRating').value) || 4.0,
                    address: document.getElementById('labAddress').value,
                    phone: document.getElementById('labPhone').value,
                    total_tests: parseInt(document.getElementById('labTests').value) || 100
                };
                const response = await API.Labs.create(lab);
                if (response.success) {
                    bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
                    showToast('Lab added successfully!', 'success');
                    loadLabs();
                }
            } catch (error) {
                console.error('Failed to add lab:', error);
                showToast('Failed to add lab', 'danger');
            }
        }

        async function handleAddDoctor(e) {
            e.preventDefault();
            try {
                const doctor = {
                    name: document.getElementById('doctorName').value,
                    specialty: document.getElementById('doctorSpecialty').value,
                    qualification: document.getElementById('doctorQualification').value,
                    experience: parseInt(document.getElementById('doctorExperience').value) || 5,
                    consultation_fee: parseInt(document.getElementById('doctorFee').value) || 500
                };
                const response = await API.Doctors.create(doctor);
                if (response.success) {
                    bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
                    showToast('Doctor added successfully!', 'success');
                    loadDoctors();
                }
            } catch (error) {
                console.error('Failed to add doctor:', error);
                showToast('Failed to add doctor', 'danger');
            }
        }

        async function handleAddCollector(e) {
            e.preventDefault();
            try {
                const collector = {
                    name: document.getElementById('collectorName').value,
                    email: document.getElementById('collectorEmail').value,
                    password: document.getElementById('collectorPassword').value,
                    phone: document.getElementById('collectorPhone').value,
                    area: document.getElementById('collectorArea').value
                };
                const response = await API.Admin.createCollector(collector);
                if (response.success) {
                    bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
                    showToast('Collector added successfully!', 'success');
                    loadCollectors();
                }
            } catch (error) {
                console.error('Failed to add collector:', error);
                showToast(error.message || 'Failed to add collector', 'danger');
            }
        }

        // Delete functions
        async function deleteTest(id) {
            if (confirm('Are you sure you want to delete this test?')) {
                try {
                    await API.Tests.delete(id);
                    showToast('Test deleted!', 'success');
                    loadTests();
                } catch (error) {
                    showToast('Failed to delete test', 'danger');
                }
            }
        }

        async function deleteLab(id) {
            if (confirm('Are you sure you want to delete this lab?')) {
                try {
                    await API.Labs.delete(id);
                    showToast('Lab deleted!', 'success');
                    loadLabs();
                } catch (error) {
                    showToast('Failed to delete lab', 'danger');
                }
            }
        }

        async function deleteDoctor(id) {
            if (confirm('Are you sure you want to delete this doctor?')) {
                try {
                    await API.Doctors.delete(id);
                    showToast('Doctor deleted!', 'success');
                    loadDoctors();
                } catch (error) {
                    showToast('Failed to delete doctor', 'danger');
                }
            }
        }

        async function deleteCollector(id) {
            if (confirm('Are you sure you want to delete this collector?')) {
                try {
                    await API.Admin.deleteUser(id);
                    showToast('Collector deleted!', 'success');
                    loadCollectors();
                } catch (error) {
                    showToast('Failed to delete collector', 'danger');
                }
            }
        }

        // Upload report
        document.getElementById('uploadReportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const bookingId = document.getElementById('reportBookingId').value;
            const reportNotes = document.getElementById('reportNotes').value;

            if (!bookingId) {
                showToast('Please select a booking first', 'danger');
                return;
            }

            try {
                const response = await API.Bookings.uploadReport(bookingId, 'report_' + bookingId + '.pdf', reportNotes);
                if (response.success) {
                    showToast('Report uploaded successfully!', 'success');
                    this.reset();
                    loadPendingReports();
                }
            } catch (error) {
                console.error('Failed to upload report:', error);
                showToast('Failed to upload report', 'danger');
            }
        });

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
        }

        // Initial load
        loadDashboard();
    </script>
</body>
</html>
